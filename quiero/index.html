<!DOCTYPE html>
<html 
    lang="en"
    class="csspositionsticky supports backgroundblendmode objectfit object-fit backgroundcliptext cssfilters cssmask backdropfilter"
>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta 
        name="viewport" 
        content="width=device-width, initial-scale=1, shrink-to-fit=no"
    >
    <!-- Local JS -->
    <script src="../utils/requestHelper.js"></script>
    <script src="../utils/bookingsRequests.js"></script>
    <script src="../utils/servicesRequests.js"></script>
    <script src="../utils/userRequests.js"></script>
    <script src="../utils/smsRequests.js"></script>
    <script src="../utils/utils.js"></script>
    <script src="../utils/smsRequests.js"></script>

    <!-- CDN -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.5.1/main.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.5.1/main.min.css" rel="stylesheet">
    <script src='fullcalendar/core/locales/es.js'></script>
    <link href='https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.1/css/all.css' rel='stylesheet'>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.7.6/lottie.min.js" integrity="sha512-BB7rb8ZBAxtdJdB7nwDijJH9NC+648xSzviK9Itm+5APTtdpgKz1+82bDl4znz/FBhd0R7pJ/gQtomnMpZYzRw==" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="../assets/style/modals.css">

    <!-- Wizzard -->
    <link rel="stylesheet" href="../assets/style/wizzard.css">
    <script src="../utils/wizard.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/4.1.3/minty/bootstrap.min.css">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;200&display=swap" rel="stylesheet">

    <!-- Header -->
    <link rel="stylesheet" href="../assets-landing/vtq7trz.css" />
    <link rel="stylesheet" href="../assets-landing/liquid-icon.min.css"/>
    <link rel="stylesheet" href="../assets-landing/font-awesome.min.css"/>
    <link rel="stylesheet" href="../assets-landing/theme-vendors.min.css"/>
    <link rel="stylesheet" href="../assets-landing/theme.min.css" />
    <link rel="stylesheet" href="../assets-landing/voguish.css" />
    <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css" integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous"/>
    <meta name="theme-color" content="#3ed2a7" />
    <link rel="shortcut icon" href="http://avehtml.liquid-themes.com/favicon.png"/>
    <script async="" src="../assets-landing/modernizr.min.js"></script>

    <title>Rosa Pastel</title>


    <script>
        var modalOpen = false
        var bookingDate = null
        var services = []
        var users = []
        var calendar = null
        var selectedBooking = false;
        var modal = null; 
        var span = null;
        var modalSms = null;
        var closeSms = null
        var codeId = null
        var modalInfo = ''
        var loadingAnimation = null
        var canContinue = false;
        var selectedUser = null
        var selectedService = null

        function createCalendar(events) {
            var calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                headerToolbar: {
                    left: 'prev,next',
                    center: 'title',
                    right: 'dayGridMonth,timeGridDay'
                },
                timeZone: 'America/Chihuahua',
                events: events,
                initialView: 'dayGridMonth',
                eventTimeFormat: { // like '14:30:00'
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                },
                dateClick: function(info){
                    onDateClicked(info)
                    
                },
                themeSystem: 'bootstrap',
                
                weekNumbers: false,
                dayMaxEvents: true,
                businessHours: {
                    daysOfWeek: [ 1, 2, 3, 4 , 5, 6], // Monday - Saturday

                    startTime: '9:00', // a start time (10am in this example)
                    endTime: '19:00', // an end time (6pm in this example)
                },
                locale: 'es',
                nowIndicator: true,
                allDaySlot: false,
                slotMinTime: '09:00:00',
                slotMaxTime: '19:00:00',
                datesSet: daySelected
            });
            calendar.render();
        }

        function onDateClicked(info) {
            let dateRegex = /^\d{4}-\d{2}-\d{2}$/;
            if(info.dateStr.match(dateRegex)) {   
                calendar.changeView('timeGridDay', info.dateStr);
            } else {
                openCreateBookingModal(info)
            }
        }

        function daySelected(dateInfo) {
            if(dateInfo.view.type == 'timeGridDay') {
                let dateDay =  dateInfo.startStr.substring(0,10)
                showLoading()
                getUnAvailableIntervals(dateDay).then((body) => {
                    let index = 1
                    for(unavailableTime of body.data){
                        let event = {
                            'id': index,
                            'title': 'Ocupado',
                            'start': formatCalendarDate(new Date(unavailableTime[0])),
                            'end': formatCalendarDate(new Date(unavailableTime[1])),
                            'eventBackgroundColor': 'rgb(255,0,0)',
                            'eventDisplay': 'inverse-background'
                        }
                        calendar.addEvent(event)
                        index++
                    }
                    setTimeout(() => {
                        hideLoading()
                    }, 1000)
                })

            }
        }

        function openCreateBookingModal(date) {
            if(modalOpen) return
            showModal()
            let d = date.dateStr + '-07:00'
            bookingDate = new Date(d)
            let lblBookingDate = document.getElementById('eventDate')
            // lblBookingDate.innerHTML = `${formatDate(bookingDate)}`
        }

        function showModal() {
            modal.style.display = "block"
            modalOpen = true
        }

        function hideModal(restart = true) {
            modalOpen = false
            modal.style.display = "none";
            if(restart) restartModalValues()
        }

        function loadServices() {
            getAllServices().then((body) => {
                services = body.data
                let serviceSelect = document.getElementById('services')
                let emptyOption = document.createElement('option')
                emptyOption.innerHTML = 'Seleccionar servicio...'
                emptyOption.setAttribute('value','null')
                serviceSelect.appendChild(emptyOption)
                var index = 0;
                for(service of services){
                    let option = document.createElement('option')
                    option.innerHTML = service.name
                    option.addEventListener("change", serviceSelected)
                    option.setAttribute('value',index)
                    index++
                    serviceSelect.appendChild(option)
                }
            })
        }

        function loadUsers(service_id) {
            getAvailableUsers(bookingDate.toISOString(),service_id).then((body) => {
                users = body.data
                if(users.length == 0) {
                    loadingAnimation.stop()
                    document.getElementById('loadingModal').style.display = 'none'
                    alert('Ups. Parece ser que no hay manicuristas disponibles. Por favor selecciona otro horario u otra fecha')
                    hideModal()
                    return
                }
                let userSelect = document.getElementById('user')
                userSelect.innerHTML = ''
                let emptyOptin = document.createElement('option')
                emptyOptin.innerHTML = 'Seleccionar manicurista...'
                emptyOptin.setAttribute('value','null')
                userSelect.appendChild(emptyOptin)
                var index = 0
                for(user of users){
                    let option = document.createElement('option')
                    option.innerHTML = user.name
                    option.setAttribute('value',index)
                    index++
                    userSelect.appendChild(option)
                }
                loadingAnimation.stop()
                document.getElementById('loadingModal').style.display = 'none'
                // modalInfo.style.display = "block"
            })
        }

        function serviceSelected() {
            let serviceSelect = document.getElementById('services')
            if(serviceSelect.value === "null") return
            document.getElementById('loadingModal').style.display = 'block'
            loadingAnimation.play()
            let index = parseInt(serviceSelect.value)
            loadUsers(services[index]._id)
        }

        function sendSMSCode() {
            if(!isInfoValid()) {
                alert('Información incorrecta o incompleta. Porfavor, revisa la información.')
                return
            }
            canContinue = true
            showLoading()
            let phone = document.getElementById('phone').value
            sendSMS(phone).then((body) => {
                hideLoading()
                if(!body.error) {
                    codeId = body.data
                    // hideModal(false)
                    // showSmsModal()
                } else {
                    alert('Ocurrio un error inesperado. Porfavor intentalo más tarde')
                }
            })

        }

        function showSmsModal() {
            modalSms.style.display = "block";
        }

        function hideSmsModal() {
            modalSms.style.display = "none";
        }

        function showLoading() {
            document.getElementById('loadingModal').style.display = 'block'
            loadingAnimation.play()
        }

        function hideLoading() {
            loadingAnimation.stop()
            document.getElementById('loadingModal').style.display = 'none'
        }

        function create() {
            if(document.getElementById('code').value === ""){
                alert('Por favor, ingresa un código valido')
                return
            }
            canContinue = true
            showLoading()
            let phone = document.getElementById('phone').value
            let name = document.getElementById('name').value
            let serviceIndex = parseInt(document.getElementById('services').value)
            let userIndex = parseInt(document.getElementById('user').value)
            let code = document.getElementById('code').value
            let comment = document.getElementById('comment').value
            let imageField = document.getElementById('reference_image')
            
            selectedService = services[serviceIndex]
            selectedUser = users[userIndex]  
            let service_id = services[serviceIndex]._id
            let user_id = users[userIndex]._id
            let start_time = bookingDate.toISOString()
            
            const formData = new FormData();
            formData.append('reference_img', imageField.files[0]);
            const data = JSON.stringify({
                phone,
                name,
                service_id,
                user_id,
                start_time,
                code,
                'sms_id': codeId,
                'comment': (comment != '')? comment : null
            })
            formData.append('data', data);

            createBooking(formData).then((body) => {
                restartModalValues()
                hideLoading()
                if(!body.error) {
                    setSummaryInfo()
                } else {
                    hideModal()
                    alert(`Ocurrio un error: ${body.message}`)
                }
            })
        }

        function isInfoValid() {
            if(document.getElementById('services').value === "null") return false
            if(document.getElementById('user').value === "null") return false
            if(!document.getElementById('phone').value.match(/^\d{10}$/)) return false
            if(document.getElementById('name').value === "")  return false
            return true
        }

        function checkValidServiceInfo() {
            var result = true
            if(document.getElementById('services').value === "null") result = false
            if(document.getElementById('user').value === "null") result = false
            canContinue = result
        }

        function checkValidContactInfo() {
            var result = true
            if(!document.getElementById('phone').value.match(/^\d{10}$/)) result = false
            if(document.getElementById('name').value === "")  result = false
            canContinue = result
        }

        function restartModalValues() {
            document.getElementById('services').value = "null"
            document.getElementById('user').value = ""
            document.getElementById('phone').value = ""
            document.getElementById('name').value = ""
            document.getElementById('code').value = ""
            // document.getElementById('modalInfo').style.display = 'none'

            let userSelect = document.getElementById('user')
            userSelect.innerHTML = ''
        }

        function setSummaryInfo() {
            let summaryDate = document.getElementById('summaryDate')
            let summaryUser = document.getElementById('summaryUser')
            let summaryService = document.getElementById('summaryService')
            
            summaryDate.innerHTML = `Fecha: ${formatDate(bookingDate)}`
            summaryUser.innerHTML = `Manicurista: ${selectedUser.name}`
            summaryService.innerHTML = `Servicio: ${selectedService.name}`
        }

        window.onload = function() {
            createCalendar([])
            loadServices()
            modal = document.getElementById("myModal");     
            span = document.getElementsByClassName("close")[0];
            span.onclick = function() {
                hideModal()
            }

        
            window.onclick = function(event) {
                modalOpen = false
                if (event.target == modal) {
                    modal.style.display = "none";
                    restartModalValues()
                }
            }
            
            loadingAnimation = lottie.loadAnimation({
                container: document.getElementById('loading'), // the dom element that will contain the animation
                renderer: 'svg',
                loop: true,
                autoplay: true,
                path: 'https://assets1.lottiefiles.com/packages/lf20_dkldbbpq.json' // the path to the animation json
            }); 
            loadingAnimation.stop()
        }


    </script>
    <title>Rosa Pastel</title>
</head>
<body
    data-mobile-nav-trigger-alignment="right"
    data-mobile-nav-align="left"
    data-mobile-nav-style="minimal"
    data-mobile-nav-shceme="gray"
    data-mobile-header-scheme="gray"
    data-mobile-nav-breakpoint="1199"
>
    <div id="wrap">
        <header
            class="main-header main-header-overlay bb-fade-white-015"
            data-sticky-header="true"
            data-sticky-options='{ "stickyTrigger": "first-section" }'
            style="background-color: #E7A285;"
        >
        <div class="lqd-sticky-placeholder hide" style="height: 66px"></div>
        <div class="mainbar-wrap">
        <div class="megamenu-hover-bg"></div>
        <div class="container-fluid mainbar-container">
            <div class="mainbar">
            <div class="row mainbar-row align-items-lg-stretch px-4">
                <div class="col pr-5">
                <div class="navbar-header">
                    <a
                    class="navbar-brand pt-20 pb-20"
                    href="http://avehtml.liquid-themes.com/index-creative.html"
                    rel="home"
                    >
                    <span class="navbar-brand-inner">
                        <img
                        class="logo-sticky"
                        src="../assets-landing/voguish-dark.svg"
                        alt="Ave WordPress Theme"
                        />
                        <img
                        class="mobile-logo-default"
                        src="../assets-landing/voguish-dark.svg"
                        alt="Ave HTML Template"
                        />
                        <img
                        class="logo-default"
                        src="../assets-landing/voguish-light.svg"
                        alt="Ave HTML Template"
                        />
                    </span>
                    </a>
                    <button
                    type="button"
                    class="navbar-toggle collapsed nav-trigger style-mobile"
                    data-toggle="collapse"
                    data-target="#main-header-collapse"
                    aria-expanded="false"
                    data-changeclassnames='{ "html": "mobile-nav-activated overflow-hidden" }'
                    >
                    <span class="sr-only">Toggle navigation</span>
                    <span class="bars">
                        <span class="bar"></span>
                        <span class="bar"></span>
                        <span class="bar"></span>
                    </span>
                    </button>
                </div>
                </div>
                <div class="col">
                <div
                    class="collapse navbar-collapse"
                    id="main-header-collapse"
                    aria-expanded="false"
                >
                    <ul
                    id="primary-nav"
                    class="main-nav nav align-items-lg-stretch justify-content-lg-center"
                    data-submenu-options='{ "toggleType":"fade", "handler":"mouse-in-out" }'
                    data-localscroll="true"
                    >
                    <li class="active is-active">
                        <a
                        href="http://avehtml.liquid-themes.com/index-voguish.html#content"
                        >
                        <span class="link-icon"></span>
                        <span class="link-txt">
                            <span class="link-ext"></span>
                            <span class="txt">Home</span>
                        </span>
                        </a>
                    </li>
                    <li class="">
                        <a
                        href="http://avehtml.liquid-themes.com/index-voguish.html#about"
                        >
                        <span class="link-icon"></span>
                        <span class="link-txt">
                            <span class="link-ext"></span>
                            <span class="txt">About</span>
                        </span>
                        </a>
                    </li>
                    <li class="">
                        <a
                        href="http://avehtml.liquid-themes.com/index-voguish.html#case-studies"
                        >
                        <span class="link-icon"></span>
                        <span class="link-txt">
                            <span class="link-ext"></span>
                            <span class="txt">Case Studies</span>
                        </span>
                        </a>
                    </li>
                    <li class="">
                        <a
                        href="http://avehtml.liquid-themes.com/index-voguish.html#features"
                        >
                        <span class="link-icon"></span>
                        <span class="link-txt">
                            <span class="link-ext"></span>
                            <span class="txt">Features</span>
                        </span>
                        </a>
                    </li>
                    <li class="">
                        <a
                        href="http://avehtml.liquid-themes.com/index-voguish.html#blog"
                        >
                        <span class="link-icon"></span>
                        <span class="link-txt">
                            <span class="link-ext"></span>
                            <span class="txt">Blog</span>
                        </span>
                        </a>
                    </li>
                    <li>
                        <a
                        href="http://avehtml.liquid-themes.com/index-voguish.html#buy"
                        >
                        <span class="link-icon"></span>
                        <span class="link-txt">
                            <span class="link-ext"></span>
                            <span class="txt">Citas</span>
                        </span>
                        </a>
                    </li>
                    </ul>
                </div>
                </div>
                <div class="col text-right">
                <div class="header-module">
                    <ul
                    class="social-icon social-icon-sm scheme-white font-size-16"
                    >
                    <li>
                        <a
                        href="http://avehtml.liquid-themes.com/index-voguish.html#"
                        target="_blank"
                        ><i class="fa fa-pinterest-p"></i
                        ></a>
                    </li>
                    <li>
                        <a
                        href="http://avehtml.liquid-themes.com/index-voguish.html#"
                        target="_blank"
                        ><i class="fa fa-twitter"></i
                        ></a>
                    </li>
                    <li>
                        <a
                        href="http://avehtml.liquid-themes.com/index-voguish.html#"
                        target="_blank"
                        ><i class="fa fa-youtube-play"></i
                        ></a>
                    </li>
                    </ul>
                </div>
                </div>
            </div>
            </div>
        </div>
        </div>
        </header>

        <main id="content" class="content">
            <section class="vc_row fullheight d-flex flex-wrap align-items-center bg-cover bg-center py-7 mb-100">
                <div class="container">
                    <div class="row">
                        <div style="width: auto;">
                            <h2>Bienvenida a Rosa Pastel</h2>
                            <p>Lorem ipsum dolor sit, amet consectetur adipisicing elit. Unde, eius. Laborum dolor maxime accusamus saepe molestiae! Deleniti dolores doloribus quod alias harum minima rem fugiat saepe praesentium, quia temporibus eveniet.</p>
                        </div>
                        <div id='calendar' style="width: 80%; margin: auto; min-width: 380px;"> 
                    </div>
                </div>
            </section>
        </main>
    </div>
    <!-- Booking modal -->
    <div id="myModal" class="modal">
        <!-- Modal content -->
        <div class="modal-content-new">
            <div class="modal-header">
                <h2>Crear Cita</h2>
                <p class="close">&times;</p>
            </div>
            <div class="modal-body">
                <div class="multisteps-form">
                    <!--progress bar-->
                    <div class="row">
                      <div class="col-12 col-lg-8 ml-auto mr-auto">
                        <div class="multisteps-form__progress">
                          <button class="multisteps-form__progress-btn js-active" type="button" title="User Info">Servicio</button>
                          <button class="multisteps-form__progress-btn" type="button" title="Address">Tú contacto</button>
                          <button class="multisteps-form__progress-btn" type="button" title="Order Info">Diseño</button>
                          <button class="multisteps-form__progress-btn" type="button" title="Comments">Confirmar Telefonó</button>
                          <button class="multisteps-form__progress-btn" type="button" title="Comments">Resumen</button>
                        </div>
                      </div>
                    </div>
                    <!--form panels-->
                    <div class="row">
                      <div class="col-12 col-lg-8 m-auto">
                        <form class="multisteps-form__form">
                          <!-- Service Panel-->
                          <div class="multisteps-form__panel p-1 rounded bg-white js-active" data-animation="fadeIn">
                            <div class="multisteps-form__content">
                              <div class="form-row mt-4">
                                <div class="col-12">
                                    <label>Elige un servicio:</label>
                                    <select onchange="serviceSelected()" class="form-control" id="services"></select>
                                </div>
                              </div>
                              <div class="form-row mt-4">
                                <div class="col-12">
                                    <label>Elige una manicurista: </label>
                                    <select  onchange="userSelected()" class="form-control" id="user"></select>
                                </div>
                              </div>
                              <div class="button-row d-flex mt-4">
                                <button class="btn btn-primary ml-auto js-btn-next" onclick="checkValidServiceInfo()" type="button" title="Next">Siguiente</button>
                              </div>
                            </div>
                          </div>
                          <!-- Contact panel -->
                          <div class="multisteps-form__panel p-4 rounded bg-white" data-animation="fadeIn">
                            <div class="multisteps-form__content">
                              <div class="form-row mt-4">
                                <div class="col">
                                    <input type="text" id="name" placeholder="Nombre" class="form-control form-control">
                                </div>
                              </div>
                              <div class="form-row mt-4">
                                <div class="col">
                                    <input type="text" id="phone" placeholder="Teléfono" class="form-control form-control">
                                </div>
                              </div>
                              <div class="button-row d-flex mt-4">
                                <button class="btn btn-primary js-btn-prev" type="button" title="Prev">Atrás</button>
                                <button class="btn btn-primary ml-auto js-btn-next" onclick="checkValidContactInfo()" type="button" title="Next">Siguiente</button>
                              </div>
                            </div>
                          </div>
                          <!--Design panel-->
                          <div class="multisteps-form__panel p-4 rounded bg-white" data-animation="fadeIn">
                            <div class="multisteps-form__content">
                              <div class="row">
                                <label for="comment">Platicanos sobre tu diseño (Opcional)</label>
                                <textarea class="form-control" id="comment" rows="3"></textarea>
                                
                                <label for="reference_image">Si tienes alguna imagen de referencia, incluyela aquí</label>
                                <input type="file" accept="image/*" class="form-control-file" id="reference_image">
                              </div>
                              <div class="row">
                                <div class="button-row d-flex mt-4 col-12">
                                  <button class="btn btn-primary js-btn-prev" type="button" title="Prev">Atrás</button>
                                  <button class="btn btn-primary ml-auto js-btn-next" onclick="sendSMSCode()" type="button" title="Next">Siguiente</button>
                                </div>
                              </div>
                            </div>
                          </div>
                          <!-- Confirm SMS code panel-->
                          <div class="multisteps-form__panel p-4 rounded bg-white" data-animation="fadeIn">
                            <h3 class="multisteps-form__title">Ingresa el codigo que se envio a tu telefono</h3>
                            <div class="multisteps-form__content">
                              <div class="form-row mt-4">
                                <input type="text" id="code" placeholder="Código" class="form-control form-control">
                              </div>
                              <div class="button-row d-flex mt-4">
                                <button class="btn btn-primary ml-auto js-btn-next" type="button" onclick="create()" title="Next">Confirmar</button>
                              </div>
                            </div>
                          </div>

                          <!-- Summary panel-->
                          <div class="multisteps-form__panel p-4 rounded bg-white" data-animation="fadeIn">
                            <h3 class="multisteps-form__title">¡Listo! Nos vemos pronto en Rosa Pastel</h3>
                            <div class="multisteps-form__content">
                              <div class="form-row mt-4">
                                <label id="summaryDate">Fecha Cita: </label><br>
                                <label id="summaryUser">Manicurista: </label><br>
                                <label id="summaryService">Servicio: </label><br>
                              </div>
                            </div>
                          </div>
                        </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loaging Modal -->
    <div id="loadingModal" class="modal" style="display: none;">

        <!-- Modal content -->
        <div class="modal-content-new">
            <div class="modal-body">
                <div id="loading" style="height: 400px;"></div>
                <center>
                    <h4 style="margin: auto;">Cargando...</h4>
                </center>
            </div>
        </div>
    
    </div>

    <script src="../assets-landing/jquery.min.js"></script>
    <script src="../assets-landing/theme-vendors.js"></script>
    <script src="../assets-landing/theme.min.js"></script>
    <script src="../assets-landing/liquidAjaxMailchimp.min.js"></script>
    <style type="text/css">
      .lqd-buy-now {
        position: fixed;
        right: 30px;
        bottom: 30px;
        z-index: 999;
      }
      .lqd-buy-now-btn {
        display: inline-flex;
        padding: 15px 30px;
        align-items: center;
        border: none;
        border-radius: 50em;
        background: #fff;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        font-size: 15px;
        line-height: 1.5em;
        color: #000;
        transition: all 0.3s;
      }
      .lqd-buy-now-btn svg {
        margin-right: 12px;
      }
      .lqd-buy-now-btn:hover {
        background: rgba(0, 0, 0, 0.8);
        color: #fff;
        transform: translateY(-2px);
      }
      .lqd-buy-now-btn:hover svg {
        fill: currentColor;
      }
    </style>
</body>
</html>