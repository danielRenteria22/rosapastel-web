<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Local JS -->
    <script src="../utils/requestHelper.js"></script>
    <script src="../utils/bookingsRequests.js"></script>
    <script src="../utils/servicesRequests.js"></script>
    <script src="../utils/userRequests.js"></script>
    <script src="../utils/smsRequests.js"></script>
    <script src="../utils/utils.js"></script>
    <script src="../utils/smsRequests.js"></script>
    <!-- CDN -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.5.1/main.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.5.1/main.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <script src='fullcalendar/core/locales/es.js'></script>
    <link href='https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.1/css/all.css' rel='stylesheet'>

    <style>
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1; /* Sit on top */
            padding-top: 100px; /* Location of the box */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgb(0,0,0); /* Fallback color */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        }

        /* Modal Content */
        .modal-content {
            position: relative;
            background-color: #fefefe;
            margin: auto;
            padding: 0;
            border: 1px solid #888;
            width: 50%;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19);
            -webkit-animation-name: animatetop;
            -webkit-animation-duration: 0.4s;
            animation-name: animatetop;
            animation-duration: 0.4s
        }

        /* Add Animation */
        @-webkit-keyframes animatetop {
            from {top:-300px; opacity:0} 
            to {top:0; opacity:1}
        }
        
        @keyframes animatetop {
            from {top:-300px; opacity:0}
            to {top:0; opacity:1}
        }
        
        /* The Close Button */
        .close {
            color: white;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        
        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        
        .modal-header {
            padding: 2px 16px;
            background-color: #ffbffc;
            color: white;
        }
        
        .modal-body {
            padding: 2px 16px;
        }
    </style>

    <script>
        var modalOpen = false
        var bookingDate = null
        var services = []
        var users = []
        var calendar = null
        var selectedBooking = false;
        var modal = null; 
        var span = null;
        var modalSms = null;
        var closeSms = null
        var codeId = null


        function createCalendar(events) {
            var calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                views: {
                    dayGridMonth: {
                        headerToolbar: {
                            left: 'prev,next today',
                            center: 'title',
                            right: 'dayGridMonth,timeGridDay'
                        }
                    },
                    timeGridDay: {
                        headerToolbar: {
                            left: '',
                            center: 'title',
                            right: 'dayGridMonth,timeGridDay'
                        },
                    }
                },
                timeZone: 'America/Chihuahua',
                events: events,
                initialView: 'dayGridMonth',
                eventTimeFormat: { // like '14:30:00'
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                },
                dateClick: function(info){
                    onDateClicked(info)
                    
                },
                themeSystem: 'bootstrap',
                
                weekNumbers: false,
                dayMaxEvents: true,
                businessHours: {
                    daysOfWeek: [ 1, 2, 3, 4 , 5, 6], // Monday - Saturday

                    startTime: '9:00', // a start time (10am in this example)
                    endTime: '19:00', // an end time (6pm in this example)
                },
                locale: 'es',
                nowIndicator: true,
                allDaySlot: false,
                slotMinTime: '09:00:00',
                slotMaxTime: '19:00:00',
            });
            calendar.render();
        }

        function onDateClicked(info) {
            let dateRegex = /^\d{4}-\d{2}-\d{2}$/;

            if(info.dateStr.match(dateRegex)) {
                getUnAvailableIntervals(info.dateStr).then((body) => {
                    let index = 1
                    for(unavailableTime of body.data){
                        let event = {
                            'id': index,
                            'title': 'Ocupado',
                            'start': formatCalendarDate(new Date(unavailableTime[0])),
                            'end': formatCalendarDate(new Date(unavailableTime[1])),
                            'eventBackgroundColor': 'rgb(255,0,0)',
                            'eventDisplay': 'inverse-background'
                        }
                        calendar.addEvent(event)
                        index++
                    }
                })
                calendar.changeView('timeGridDay', info.dateStr);
            } else {
                openCreateBookingModal(info)
            }
        }

        function openCreateBookingModal(date) {
            if(modalOpen) return
            showModal()
            let d = date.dateStr + '-07:00'
            bookingDate = new Date(d)
            let lblBookingDate = document.getElementById('eventDate')
            lblBookingDate.innerHTML = `Fecha y hora: ${formatDate(bookingDate)}`
        }

        function showModal() {
            modal.style.display = "block"
            modalOpen = true
        }

        function hideModal() {
            modalOpen = false
            modal.style.display = "none";
        }

        function loadServices() {
            getAllServices().then((body) => {
                services = body.data
                let serviceSelect = document.getElementById('services')
                let emptyOption = document.createElement('option')
                emptyOption.innerHTML = 'Seleccionar servicio...'
                serviceSelect.appendChild(emptyOption)
                var index = 0;
                for(service of services){
                    let option = document.createElement('option')
                    option.innerHTML = service.name
                    option.addEventListener("change", serviceSelected)
                    option.setAttribute('value',index)
                    index++
                    serviceSelect.appendChild(option)
                }
            })
        }

        function loadUsers(service_id) {
            getAvailableUsers(bookingDate.toISOString(),service_id).then((body) => {
                users = body.data
                if(users.length == 0) {
                    alert('Ups. Parece ser que no hay manicuristas disponibles. Por favor selecciona otro horario u otra fecha')
                    hideModal()
                    return
                }
                let userSelect = document.getElementById('user')
                userSelect.innerHTML = ''
                var index = 0
                for(user of users){
                    let option = document.createElement('option')
                    option.innerHTML = user.name
                    option.setAttribute('value',index)
                    index++
                    userSelect.appendChild(option)
                }
            })
        }

        function serviceSelected() {
            let serviceSelect = document.getElementById('services')
            let index = parseInt(serviceSelect.value)
            loadUsers(services[index]._id)
        }

        function sendSMSCode() {
            let phone = document.getElementById('phone').value
            // sendSMS(phone).then((body) => {
            //     if(!body.error) {
            //         console.log(body)
            //         codeId = body.data
            //         hideModal()
            //         console.log('Hiodden')
            //         showSmsModal()
            //         console.log('Shwing')
            //     } else {
            //         alert('Ocurrio un error inesperado. Porfavor intentalo más tarde')
            //     }
            // })

            codeId = '60512e38495700c269d098f0'
            hideModal()
            showSmsModal()
        }

        function showSmsModal() {
            modalSms.style.display = "block";
        }

        function hideSmsModal() {
            modalSms.style.display = "none";
        }

        function create() {
            let phone = document.getElementById('phone').value
            let name = document.getElementById('name').value
            let serviceIndex = parseInt(document.getElementById('services').value)
            let userIndex = parseInt(document.getElementById('user').value)
            let code = document.getElementById('code').value
            
            let service_id = services[serviceIndex]._id
            let user_id = users[userIndex]._id
            let start_time = bookingDate.toISOString()
            console.log(codeId)

            createBooking(start_time,service_id,user_id,name,phone,codeId,code).then((body) => {
                console.log(body)
                if(!body.error) {
                    hideSmsModal()
                    alert('Listo! Nos vemos en rosa pastel')
                } else {
                    alert(`Ocurrio un error: ${body.message}`)
                }
            })
        }

        window.onload = function() {
            createCalendar([])
            loadServices()
            modal = document.getElementById("myModal");     
            span = document.getElementsByClassName("close")[0];
            modalSms = document.getElementById('smsModal')
            closeSms = document.getElementsByClassName("close")[1];

            span.onclick = function() {
                hideModal()
            }

            closeSms.onclick = function() {
                hideSmsModal()
            }

            window.onclick = function(event) {
                modalOpen = false
                if (event.target == modal) {
                    modal.style.display = "none";
                }

                if(event.target == modalSms){
                    hideSmsModal()
                }
            }   
        }


    </script>
    <title>Rosa Pastel</title>
</head>
<body>
    <div id='calendar'></div>

    <!-- Booking modal -->
    <div id="myModal" class="modal" width="500px">

        <!-- Modal content -->
        <div class="modal-content">
            <div class="modal-header">
                <span class="close">&times;</span>
                <h2>Crear Cita</h2>
            </div>
            <div class="modal-body">
                <p id="eventDate">Fecha Cita: </p>
                <label>Servicios:</label>
                <select onchange="serviceSelected()" id="services"></select>
                <br><br>

                <label>Manicurista: </label>
                <select  onchange="userSelected()" id="user"></select>
                <br><br>

                <label for="name">Nombre: </label>
                <input type="text" id="name" name="name"><br><br>

                <label for="phone">Num celular: </label>
                <input type="text" id="phone" name="phone"><br><br>


                <button onclick="sendSMSCode()">Crear</button>
            </div>
        </div>
    
    </div>

    <!-- SMS Modal -->
    <div id="smsModal" class="modal">

        <!-- Modal content -->
        <div class="modal-content">
            <div class="modal-header">
                <span class="close">&times;</span>
                <h2>Confirmar SMS</h2>
            </div>
            <div class="modal-body">
                <label for="phone">Código: </label>
                <input type="text" id="code" name="code"><br><br>
                <button onclick="create()">Confirmar</button>
            </div>
        </div>
    
    </div>
</body>
</html>