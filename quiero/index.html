<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Local JS -->
    <script src="../utils/requestHelper.js"></script>
    <script src="../utils/bookingsRequests.js"></script>
    <script src="../utils/servicesRequests.js"></script>
    <script src="../utils/userRequests.js"></script>
    <script src="../utils/smsRequests.js"></script>
    <script src="../utils/utils.js"></script>
    <script src="../utils/smsRequests.js"></script>
    <!-- CDN -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.5.1/main.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.5.1/main.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <script src='fullcalendar/core/locales/es.js'></script>
    <link href='https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.1/css/all.css' rel='stylesheet'>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.7.6/lottie.min.js" integrity="sha512-BB7rb8ZBAxtdJdB7nwDijJH9NC+648xSzviK9Itm+5APTtdpgKz1+82bDl4znz/FBhd0R7pJ/gQtomnMpZYzRw==" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="../assets/style/modals.css">
    <script>
        var modalOpen = false
        var bookingDate = null
        var services = []
        var users = []
        var calendar = null
        var selectedBooking = false;
        var modal = null; 
        var span = null;
        var modalSms = null;
        var closeSms = null
        var codeId = null
        var modalInfo = ''
        var loadingAnimation = null

        function createCalendar(events) {
            var calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                views: {
                    dayGridMonth: {
                        headerToolbar: {
                            left: 'prev,next today',
                            center: 'title',
                            right: 'dayGridMonth,timeGridDay'
                        }
                    },
                    timeGridDay: {
                        headerToolbar: {
                            left: '',
                            center: 'title',
                            right: 'dayGridMonth,timeGridDay'
                        },
                    }
                },
                timeZone: 'America/Chihuahua',
                events: events,
                initialView: 'dayGridMonth',
                eventTimeFormat: { // like '14:30:00'
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                },
                dateClick: function(info){
                    onDateClicked(info)
                    
                },
                themeSystem: 'bootstrap',
                
                weekNumbers: false,
                dayMaxEvents: true,
                businessHours: {
                    daysOfWeek: [ 1, 2, 3, 4 , 5, 6], // Monday - Saturday

                    startTime: '9:00', // a start time (10am in this example)
                    endTime: '19:00', // an end time (6pm in this example)
                },
                locale: 'es',
                nowIndicator: true,
                allDaySlot: false,
                slotMinTime: '09:00:00',
                slotMaxTime: '19:00:00',
            });
            calendar.render();
        }

        function onDateClicked(info) {
            let dateRegex = /^\d{4}-\d{2}-\d{2}$/;

            if(info.dateStr.match(dateRegex)) {
                document.getElementById('loadingModal').style.display = 'block'
                loadingAnimation = lottie.loadAnimation({
                    container: document.getElementById('loading'), // the dom element that will contain the animation
                    renderer: 'svg',
                    loop: true,
                    autoplay: true,
                    path: 'https://assets1.lottiefiles.com/packages/lf20_dkldbbpq.json' // the path to the animation json
                });
                getUnAvailableIntervals(info.dateStr).then((body) => {
                    let index = 1
                    for(unavailableTime of body.data){
                        let event = {
                            'id': index,
                            'title': 'Ocupado',
                            'start': formatCalendarDate(new Date(unavailableTime[0])),
                            'end': formatCalendarDate(new Date(unavailableTime[1])),
                            'eventBackgroundColor': 'rgb(255,0,0)',
                            'eventDisplay': 'inverse-background'
                        }
                        calendar.addEvent(event)
                        index++
                    }
                    calendar.changeView('timeGridDay', info.dateStr);
                    loadingAnimation.stop()
                    document.getElementById('loadingModal').style.display = 'none'
                })
            } else {
                openCreateBookingModal(info)
            }
        }

        function openCreateBookingModal(date) {
            if(modalOpen) return
            showModal()
            let d = date.dateStr + '-07:00'
            bookingDate = new Date(d)
            let lblBookingDate = document.getElementById('eventDate')
            lblBookingDate.innerHTML = `${formatDate(bookingDate)}`
        }

        function showModal() {
            modal.style.display = "block"
            modalOpen = true
        }

        function hideModal() {
            modalOpen = false
            modal.style.display = "none";
            restartModalValues()
        }

        function loadServices() {
            getAllServices().then((body) => {
                services = body.data
                let serviceSelect = document.getElementById('services')
                let emptyOption = document.createElement('option')
                emptyOption.innerHTML = 'Seleccionar servicio...'
                emptyOption.setAttribute('value','null')
                serviceSelect.appendChild(emptyOption)
                var index = 0;
                for(service of services){
                    let option = document.createElement('option')
                    option.innerHTML = service.name
                    option.addEventListener("change", serviceSelected)
                    option.setAttribute('value',index)
                    index++
                    serviceSelect.appendChild(option)
                }
            })
        }

        function loadUsers(service_id) {
            getAvailableUsers(bookingDate.toISOString(),service_id).then((body) => {
                users = body.data
                if(users.length == 0) {
                    loadingAnimation.stop()
                    document.getElementById('loadingModal').style.display = 'none'
                    alert('Ups. Parece ser que no hay manicuristas disponibles. Por favor selecciona otro horario u otra fecha')
                    hideModal()
                    return
                }
                let userSelect = document.getElementById('user')
                userSelect.innerHTML = ''
                let emptyOptin = document.createElement('option')
                emptyOptin.innerHTML = 'Seleccionar manicurista...'
                emptyOptin.setAttribute('value','null')
                userSelect.appendChild(emptyOptin)
                var index = 0
                for(user of users){
                    let option = document.createElement('option')
                    option.innerHTML = user.name
                    option.setAttribute('value',index)
                    index++
                    userSelect.appendChild(option)
                }
                loadingAnimation.stop()
                document.getElementById('loadingModal').style.display = 'none'
                modalInfo.style.display = "block"
            })
        }

        function serviceSelected() {
            let serviceSelect = document.getElementById('services')
            if(serviceSelect.value === "null") return
            document.getElementById('loadingModal').style.display = 'block'
            loadingAnimation.play()
            let index = parseInt(serviceSelect.value)
            loadUsers(services[index]._id)
        }

        function sendSMSCode() {
            if(!isInfoValid()) {
                alert('Información incorrecta o incompleta. Porfavor, revisa la información.')
                return
            }
            let phone = document.getElementById('phone').value
            // sendSMS(phone).then((body) => {
            //     if(!body.error) {
            //         console.log(body)
            //         codeId = body.data
            //         hideModal()
            //         console.log('Hiodden')
            //         showSmsModal()
            //         console.log('Shwing')
            //     } else {
            //         alert('Ocurrio un error inesperado. Porfavor intentalo más tarde')
            //     }
            // })

            codeId = '60512e38495700c269d098f0'
            hideModal()
            showSmsModal()
        }

        function showSmsModal() {
            modalSms.style.display = "block";
        }

        function hideSmsModal() {
            modalSms.style.display = "none";
        }

        function create() {
            if(document.getElementById('code').value === ""){
                alert('Por favor, ingresa un código valido')
                return
            }
            document.getElementById('loadingModal').style.display = 'block'
            loadingAnimation.play()
            let phone = document.getElementById('phone').value
            let name = document.getElementById('name').value
            let serviceIndex = parseInt(document.getElementById('services').value)
            let userIndex = parseInt(document.getElementById('user').value)
            let code = document.getElementById('code').value
            let comment = document.getElementById('comment').value
            let imageField = document.getElementById('reference_image')
            
            let service_id = services[serviceIndex]._id
            let user_id = users[userIndex]._id
            let start_time = bookingDate.toISOString()
            
            const formData = new FormData();
            formData.append('reference_img', imageField.files[0]);
            const data = JSON.stringify({
                phone,
                name,
                service_id,
                user_id,
                start_time,
                code,
                'sms_id': codeId,
                'comment': (comment != '')? comment : null
            })
            formData.append('data', data);

            createBooking(formData).then((body) => {
                restartModalValues()
                loadingAnimation.stop()
                document.getElementById('loadingModal').style.display = 'none'
                if(!body.error) {
                    hideSmsModal()
                    alert('Listo! Nos vemos en rosa pastel')
                } else {
                    alert(`Ocurrio un error: ${body.message}`)
                }
            })
        }

        function isInfoValid() {
            if(document.getElementById('services').value === "null") return false
            if(document.getElementById('user').value === "null") return false
            if(!document.getElementById('phone').value.match(/^\d{10}$/)) return false
            if(document.getElementById('name').value === "")  return false
            return true
        }

        function restartModalValues() {
            document.getElementById('services').value = "null"
            document.getElementById('user').value = ""
            document.getElementById('phone').value = ""
            document.getElementById('name').value = ""
            document.getElementById('code').value = ""
            document.getElementById('modalInfo').style.display = 'none'

            let userSelect = document.getElementById('user')
            userSelect.innerHTML = ''
        }

        window.onload = function() {
            createCalendar([])
            loadServices()
            modal = document.getElementById("myModal");     
            span = document.getElementsByClassName("close")[0];
            modalSms = document.getElementById('smsModal')
            closeSms = document.getElementsByClassName("close")[1];
            modalInfo = document.getElementById('modalInfo')
            modalInfo.style.display = "none";

            span.onclick = function() {
                hideModal()
            }

            closeSms.onclick = function() {
                hideSmsModal()
            }

            window.onclick = function(event) {
                modalOpen = false
                if (event.target == modal) {
                    modal.style.display = "none";
                    restartModalValues()
                }

                if(event.target == modalSms){
                    hideSmsModal()
                }
            }   
        }


    </script>
    <title>Rosa Pastel</title>
</head>
<body>
    <br>
    <h1>Bienvenida a Rosa Pastel</h1>
    <br><br>
    <div id='calendar' style="width: 90%; margin: auto; min-width: 380px;"></div>
    <!-- Booking modal -->
    <div id="myModal" class="modal">

        <!-- Modal content -->
        <div class="modal-content">
            <div class="modal-header">
                <h2>Crear Cita</h2>
                <p class="close">&times;</p>
            </div>
            <div class="modal-body">
                <h4 id="eventDate">Fecha Cita: </h4>

                <div class="form-group">
                    <label>Elige un servicio:</label>
                    <select onchange="serviceSelected()" class="form-control" id="services"></select>
                </div>

                <div id="modalInfo">
                    <div class="form-group">
                        <label>Elige una manicurista: </label>
                        <select  onchange="userSelected()" class="form-control" id="user"></select>
                    </div>
    
                    <div class="form-group">
                        <input type="text" id="name" placeholder="Nombre" class="form-control form-control">
                    </div>
    
                    <div class="form-group">
                        <input type="text" id="phone" placeholder="Teléfono" class="form-control form-control">
                    </div>

                    <div class="form-group">
                        <label for="comment">Platicanos sobre tu diseño</label>
                        <textarea class="form-control" id="comment" rows="3"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="reference_image">Si tienes alguna imagen de referencia, incluyela aquí</label>
                        <input type="file" accept="image/*" class="form-control-file" id="reference_image">
                    </div>
    
                    <button onclick="sendSMSCode()" class="btn btn-primary">Crear</button>
                </div>
            </div>
        </div>
    
    </div>

    <!-- SMS Modal -->
    <div id="smsModal" class="modal">

        <!-- Modal content -->
        <div class="modal-content">
            <div class="modal-header">
                <h2>Confirmar Teléfono</h2>
                <p class="close">&times;</p>
            </div>
            <div class="modal-body">
                <br>
                <div class="form-group">
                    <input type="text" id="code" placeholder="Código" class="form-control form-control">
                </div>
                <button onclick="create()" class="btn btn-primary">Confirmar</button>
            </div>
        </div>
    
    </div>

    <!-- Loaging Modal -->
    <div id="loadingModal" class="modal" style="display: none;">

        <!-- Modal content -->
        <div class="modal-content">
            <div class="modal-body">
                <div id="loading"></div>
                <center>
                    <h4 style="margin: auto;">Cargando...</h4>
                </center>
            </div>
        </div>
    
    </div>
</body>
</html>