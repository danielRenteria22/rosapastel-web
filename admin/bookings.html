<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Local JS -->
    <script src="../utils/requestHelper.js"></script>
    <script src="../utils/bookingsRequests.js"></script>
    <script src="../utils/servicesRequests.js"></script>
    <script src="../utils/userRequests.js"></script>
    <script src="../utils/smsRequests.js"></script>
    <script src="../utils/utils.js"></script>
    <!-- CDN -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.5.1/main.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.5.1/main.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <script src='fullcalendar/core/locales/es.js'></script>
    <link href='https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.1/css/all.css' rel='stylesheet'>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.7.6/lottie.min.js" integrity="sha512-BB7rb8ZBAxtdJdB7nwDijJH9NC+648xSzviK9Itm+5APTtdpgKz1+82bDl4znz/FBhd0R7pJ/gQtomnMpZYzRw==" crossorigin="anonymous"></script>
    
    <!-- Local Styles -->
    <link rel="stylesheet" href="../assets/style/modals.css">
    <style>
        html, body {
        margin: 0;
        padding: 20px 20px;
        font-family: Arial, Helvetica Neue, Helvetica, sans-serif;
        font-size: 14px;
        }

        #calendar {
        max-width: 1100px;
        margin: 40px auto;
        }
    </style>

    <script>
        var modalOpen = false
        var bookingDate = null
        var services = []
        var users = []
        var calendar = null
        var selectedBooking = false;
        var modal = null; 
        var span = null;
        var modalSummary = null;
        var closeSummary = null
        var loadingAnimation = null

        function loadMonthBookings() {
            let currentDate = new Date()
            currentDate = currentDate.toISOString()
            getMonthBookings(currentDate).then((body) => {
                let events = []
                for(booking of body.data) {
                    events.push(createEvent(booking))
                }
                createCalendar(events)
            })
        }

        function createEvent(booking) {
            let startDate = new Date(booking.start_time)
            let endDate = new Date(startDate.getTime() + booking.service.minutesDuration*60000)
            if(booking.end_time != null) {
                endDate = new Date(booking.end_time)
            }
            let event = {
                'id': booking._id,
                'title':`${booking.service.name} - ${booking.name}`,
                'start': formatCalendarDate(startDate),
                'end': formatCalendarDate(endDate),
                'display': 'block',
                'description': booking.user.name,
                'allDay': false,
                'extendedProps': {
                    'user_name': booking.user.name,
                    'client_name': booking.name,
                    'client_phone': booking.phone,
                    'service_name': booking.service.name,
                    'comment': booking.comment,
                    'reference_url': booking.reference_url
                }
            }
            return event
        }

        function loadServices() {
            getAllServices().then((body) => {
                services = body.data
                let serviceSelect = document.getElementById('services')
                let emptyOption = document.createElement('option')
                emptyOption.innerHTML = 'Seleccionar servicio...'
                emptyOption.setAttribute('value',"null")
                serviceSelect.appendChild(emptyOption)
                var index = 0;
                for(service of services){
                    let option = document.createElement('option')
                    option.innerHTML = service.name
                    option.addEventListener("change", serviceSelected)
                    option.setAttribute('value',index)
                    index++
                    serviceSelect.appendChild(option)
                }
            })
        }

        function serviceSelected() {
            let serviceSelect = document.getElementById('services')
            let index = parseInt(serviceSelect.value)
            loadUsers(services[index]._id)
        }

        window.onload = function() {
            loadMonthBookings()
            loadServices()
            modal = document.getElementById("myModal");     
            span = document.getElementsByClassName("close")[0];
            modalSummary = document.getElementById('summaryModal')
            closeSummary = document.getElementsByClassName("closeSummary")[0];

            span.onclick = function() {
                hideModal()
            }

            closeSummary.onclick = function() {
                hideSummaryModal()
            }

            window.onclick = function(event) {
                modalOpen = false
                if (event.target == modal) {
                    modal.style.display = "none";
                    restartModalValues()
                }
                if(event.target == modalSummary){
                    hideSummaryModal()
                }
            }
            loadingAnimation = lottie.loadAnimation({
                container: document.getElementById('loading'), // the dom element that will contain the animation
                renderer: 'svg',
                loop: true,
                autoplay: true,
                path: 'https://assets1.lottiefiles.com/packages/lf20_dkldbbpq.json' // the path to the animation json
            }); 
            loadingAnimation.stop()
        }

        function createCalendar(events) {
            var calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                timeZone: 'America/Chihuahua',
                events: events,
                initialView: 'dayGridMonth',
                eventTimeFormat: { // like '14:30:00'
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                },
                dateClick: function(info){
                    onDateClicked(info)
                    
                },
                eventClick: function(info) {
                    showSummaryModal(info.event)
                },
                themeSystem: 'bootstrap',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay,listMonth'
                },
                weekNumbers: true,
                dayMaxEvents: true,
                businessHours: {
                    daysOfWeek: [ 1, 2, 3, 4 , 5, 6], // Monday - Saturday

                    startTime: '9:00', // a start time (10am in this example)
                    endTime: '19:01', // an end time (6pm in this example)
                },
                locale: 'es',
                nowIndicator: true,
                allDaySlot: false,
                slotMinTime: '09:00:00',
                slotMaxTime: '19:00:00',
                editable: true,
                eventDrop: dragEvent,
                eventResize: resizeEvent
            });
            calendar.render();
        }

        function onDateClicked(info) {
            let dateRegex = /^\d{4}-\d{2}-\d{2}$/;

            if(info.dateStr.match(dateRegex)) {
                calendar.changeView('timeGridDay', info.dateStr);
            } else {
                openCreateBookingModal(info)
            }
        }
        
        function openCreateBookingModal(date) {
            if(modalOpen) return
            showModal()
            let d = date.dateStr + '-07:00'
            bookingDate = new Date(d)
            let lblBookingDate = document.getElementById('eventDate')
            lblBookingDate.innerHTML = `Fecha y hora: ${formatDate(bookingDate)}`
        }

        function showModal() {
            modal.style.display = "block"
            modalOpen = true
        }

        function hideModal() {
            modalOpen = false
            modal.style.display = "none";
            restartModalValues()
        }

        function showSummaryModal(event) {
            console.log(event)
            selectedBooking = event
            let summaryDate = document.getElementById('summaryDate')
            let summaryUser = document.getElementById('summaryUser')
            let summaryService = document.getElementById('summaryService')
            let summaryClientName = document.getElementById('summaryClientName')
            let summaryClientPhone = document.getElementById('summaryClientPhone')

            summaryDate.innerHTML = formatDate(event.startStr)
            summaryUser.innerHTML = `Manicurista: ${event.extendedProps.user_name}`
            summaryService.innerHTML = `Servicio: ${event.extendedProps.service_name}`
            summaryClientName.innerHTML = `Cliente: ${event.extendedProps.client_name}`
            summaryClientPhone.innerHTML = `Telefono: ${event.extendedProps.client_phone}`
            
            modalSummary.style.display = "block";

            if(event.extendedProps.comment != null || event.extendedProps.reference_url != null){
                document.getElementById('btnShowReferences').style.display = 'block'
                document.getElementById('comment').innerHTML = event.extendedProps.comment
                document.getElementById('reference_image').setAttribute('src',event.extendedProps.reference_url)
            } else {
                document.getElementById('btnShowReferences').style.display = 'none'
            }

        }

        function hideSummaryModal() {
            modalSummary.style.display = "none";
        }

        function showLoadingModal() {
            document.getElementById('loadingModal').style.display = 'block'
            loadingAnimation.play()
        }

        function hideLoadingModal() {
            loadingAnimation.stop()
            document.getElementById('loadingModal').style.display = 'none'
        }


        function loadUsers(service_id) {
            showLoadingModal()
            getAvailableUsers(bookingDate.toISOString(),service_id).then((body) => {
                hideLoadingModal()
                document.getElementById('modalInfo').style.display = 'block'
                users = body.data
                let userSelect = document.getElementById('user')
                userSelect.innerHTML = ''
                let defaultOption = document.createElement('option')
                defaultOption.innerHTML = 'Seleccionar manicurista...'
                defaultOption.setAttribute('value',"")
                userSelect.appendChild(defaultOption)
                var index = 0
                for(user of users){
                    let option = document.createElement('option')
                    option.innerHTML = user.name
                    option.setAttribute('value',index)
                    index++
                    userSelect.appendChild(option)
                }
            })
        }

        function create() {
            if(!isInfoValid()) {
                alert('Información incorrecta o incompleta. Porfavor, revisa la información.')
                return
            }
            showLoadingModal()
            let phone = document.getElementById('phone').value
            let name = document.getElementById('name').value
            let serviceIndex = parseInt(document.getElementById('services').value)
            let userIndex = parseInt(document.getElementById('user').value)
            
            let service_id = services[serviceIndex]._id
            let user_id = users[userIndex]._id
            let start_time = bookingDate.toISOString()

            const formData = new FormData();
            const data = JSON.stringify({
                phone,
                name,
                service_id,
                user_id,
                start_time
            })
            formData.append('data', data);

            createForceBooking(formData).then((body) => {
                hideLoadingModal()
                restartModalValues()
                console.log(body)
                if(!body.error) {
                    // loadMonthBookings()
                    calendar.addEvent(createEvent(body.data))
                    hideModal()
                }
            })
        }

        function isInfoValid() {
            if(document.getElementById('services').value === "null") return false
            if(document.getElementById('user').value === "") return false
            if(!document.getElementById('phone').value.match(/^\d{10}$/)) return false
            if(document.getElementById('name').value === "")  return false
            return true
        }

        function restartModalValues() {
            document.getElementById('services').value = "null"
            document.getElementById('user').value = ""
            document.getElementById('phone').value = ""
            document.getElementById('name').value = ""
            document.getElementById('modalInfo').style.display = 'none'

            let userSelect = document.getElementById('user')
            userSelect.innerHTML = ''
        }

        function deleteEvent() {
            if(selectedBooking != null) {
                deleteBooking(selectedBooking.id).then((body) => {
                    console.log(body)
                    if(!body.error){ 
                        selectedBooking.remove()
                        hideSummaryModal()
                    }
                })
            }
        }


        function dragEvent(event) {
            let newStartDate = new Date(event.event.startStr)
            let start_time = newStartDate.toISOString()
            let eventId = event.event.id
            changeStartTime(eventId,start_time).then((body) => {
                if(!body.error){
                    alert('Cambio exitoso')
                } else {
                    event.revert()
                    alert('Ocurrió un error inesperado')
                }
            })
        }

        function resizeEvent(event) {
            let newStartDate = new Date(event.event.startStr)
            let newEndDate = new Date(event.event.endStr)
            let start_time = newStartDate.toISOString()
            let end_time = newEndDate.toISOString()
            let eventId = event.event.id
            changeDuration(eventId,start_time,end_time).then((body) => {
                if(!body.error) {
                    alert('Cambio exitoso')
                } else {
                    alert('Ocurrió un error inesperado')
                    event.revert()
                }
            })
        }
    </script>
    <title>Rosa Pastel - Admin</title>
</head>
<body>
    <h1>Calendario Rosa Pastel</h1>
    <br><br>
    <div id='calendar' style="width: 90%; margin: auto; min-width: 380px;"></div>

    <!-- The Modal -->
    <div id="myModal" class="modal">

        <!-- Modal content -->
        <div class="modal-content-new">
            <div class="modal-header">
                <h2>Crear Cita</h2>
                <p class="close">&times;</p>
            </div>
            <div class="modal-body">
                <h4 id="eventDate">Fecha Cita: </h4>
                <div class="form-group">
                    <label>Elige un servicio:</label>
                    <select onchange="serviceSelected()" class="form-control" id="services"></select>
                </div>

                <div id="modalInfo" style="display: none;">
                    <div class="form-group">
                        <label>Elige una manicurista: </label>
                        <select  onchange="userSelected()" class="form-control" id="user"></select>
                    </div>

                    <div class="form-group">
                        <input type="text" id="name" placeholder="Nombre" class="form-control form-control">
                    </div>
    
                    <div class="form-group">
                        <input type="text" id="phone" placeholder="Teléfono" class="form-control form-control">
                    </div>
                    
                    <button onclick="create()" class="btn btn-primary">Crear</button>
                </div>
            </div>
        </div>
    
    </div>

    <!-- Booking Summary Model -->
    <div id="summaryModal" class="modal">

        <!-- Modal content -->
        <div class="modal-content-new">
            <div class="modal-header">
                <h2>Cita</h2>
                <p class="closeSummary">&times;</p>
            </div>
            <div class="modal-body">
                <p id="summaryDate">Fecha Cita: </p>
                <p id="summaryUser">Manicurista: </p>
                <p id="summaryService">Servicio: </p>
                <p id="summaryClientName">Nombre: </p>
                <p id="summaryClientPhone">Nombre: </p>
                <p>
                    <button class="btn btn-primary" id="btnShowReferences" type="button" data-toggle="collapse" data-target="#collapseExample" aria-expanded="false" aria-controls="collapseExample">
                        Mostrar referencias
                    </button>
                </p>
                <div class="collapse" id="collapseExample">
                    <div class="card card-body">
                      <p id="comment"></p>
                      <img id="reference_image" style="margin: auto; max-width: 350px;">
                    </div>
                </div>
                <button onclick="deleteEvent()" class="btn btn-danger">Eliminar</button>
            </div>
        </div>
    
    </div>

    <!-- Loaging Modal -->
    <div id="loadingModal" class="modal" style="display: none;">
        <!-- Modal content -->
        <div class="modal-content-new">
            <div class="modal-body">
                <div id="loading"></div>
                <center>
                    <h4 style="margin: auto;">Cargando...</h4>
                </center>
            </div>
        </div>
    
    </div>
</body>
</html>